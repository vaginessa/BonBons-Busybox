#!/sbin/sh
OUTFD=$2
ZIPNAME=$3
mount -o remount,rw /system
export PATH=/tmp:/sbin
#-- Permission changer --#
Set_Perm(){
	chown $1:$2 $4
	chmod $3 $4
}
#-- ui_print --#
UI_PR(){
  echo "ui_print $1" > /proc/self/fd/$OUTFD
}
#-- Menu --#
UI_PR "___________________"
UI_PR "__Modular Busybox__"
UI_PR "____By:  BonBon____"
UI_PR "___________________"
UI_PR " "
if [ -n `getprop ro.product.cpu.abi` ]; then
	case `getprop ro.product.cpu.abi` in
		*arm*) BBVER=busybox_arm;;
		*x86*) BBVER=busybox_x86;;
		*) BBVER=busybox_mips;;
	esac
elif [ -n `getprop ro.product.cpu.abilist` ]; then
	case `getprop ro.product.cpu.abilist` in
		*arm*) BBVER=busybox_arm;;
		*x86*) BBVER=busybox_x86;;
		*) BBVER=busybox_mips;;
	esac
else
	UI_PR "* Your device isn't combatiple with this zip *"
	UI_PR "* It doesn't support ro.product.cpu.abi[list] *"
	UI_PR "* Exiting *"
fi
UI_PR "- Your busybox will be: $BBVER"
UI_PR " "
sleep 3
#-- extracting new busybox --#
unzip -o "$ZIPNAME" $BBVER -d /tmp
#-- Removing old Busyboxes --#
for i in `busybox find /system/xbin -type l`; do
	if echo `busybox readlink $i` | busybox grep "busybox"; then
		busybox rm $i
		UI_PR "- Removed old '$i' symlink"
	fi
done
#-- Installing new Busybox --#
UI_PR " "
UI_PR "- Installing new busybox"
mv /tmp/$BBVER /system/xbin/busybox
export PATH=/tmp:/sbin:/system/xbin
sleep 3
Set_Perm 0 2000 0755 /system/xbin/busybox
UI_PR "- Symlinking busybox"
for i in `busybox --list`; do 
	busybox ln -sf /system/xbin/busybox /system/xbin/$i
	UI_PR "- Symlinked '$i'"
	Set_Perm 0 2000 0755 /system/xbin/$i
	UI_PR "- Set permissions for '$i'"
done
UI_PR "* DONE! Busybox was installed! *"
UI_PR " "
