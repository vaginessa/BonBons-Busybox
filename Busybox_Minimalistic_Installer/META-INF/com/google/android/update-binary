#!/sbin/sh
OUTFD=/proc/self/fd/$2
ZIPNAME=$3
mount /system
mount -o remount,rw /system
#-- Permission changer --#
Set_Perm(){
	chown $1:$2 $4
	chmod $3 $4
}
#-- ui_print --#
UI_PR(){
  echo "ui_print $1" > "$OUTFD"
}
#-- SET_PROGRESS
SET_PROG () {
	echo "set_progress $1" > "$OUTFD"
}
#-- ERROR --#
ERROR () {
	UI_PR "** ERROR **"
	UI_PR "* Your device isn't combatiple with this installer *"
	UI_PR "* $1 *"
	UI_PR "* Exiting *"
	SET_PROG 1.0
	exit
}
#-- Menu --#
UI_PR "___________________"
UI_PR "_Busybox Installer_"
UI_PR "____By:  BonBon____"
UI_PR "___________________"
UI_PR " "
SET_PROG 0.1
if [ -n `getprop ro.product.cpu.abi` ]; then
	case `getprop ro.product.cpu.abi` in
		*arm*) BBVER=busybox_arm;;
		*x86*) BBVER=busybox_x86;;
		*mips*) BBVER=busybox_mips;;
		*) ERROR "Your processor platform isn't supported";;
	esac
elif [ -n `getprop ro.product.cpu.abilist` ]; then
	case `getprop ro.product.cpu.abilist` in
		*arm*) BBVER=busybox_arm;;
		*x86*) BBVER=busybox_x86;;
		*mips*) BBVER=busybox_mips;;
		*) ERROR "Your processor platform isn't supported";;
	esac
else
	ERROR "* It doesn't support ro.product.cpu.abi[list] *"
fi
SET_PROG 0.3
#-- extracting new busybox --#
unzip -o "$ZIPNAME" $BBVER -d /tmp
UI_PR "- Your busybox is: $BBVER"
UI_PR " "
sleep 2
SET_PROG 0.4
#-- Removing old Busyboxes --#
BB_OLD=`/system/xbin/busybox | head -1 | awk '{print $1," ",$2}'`
UI_PR "- Removing the previous busybox: $BB_OLD"
UI_PR " "
sleep 2
for i in `/system/xbin/busybox --list`; do
	if [ -e /system/xbin/$i ]; then
		/tmp/$BBVER rm -f $i
		UI_PR "- Removed old symlink '$i'"
	fi
done
SET_PROG 0.6
#-- Installing new Busybox --#
UI_PR " "
UI_PR "- Installing new busybox"
UI_PR " "
mv /tmp/$BBVER /system/xbin/busybox
Set_Perm 0 2000 0755 /system/xbin/busybox
sleep 2
SET_PROG 0.7
for i in `/system/xbin/busybox --list`; do 
	/system/xbin/busybox ln -sf /system/xbin/busybox /system/xbin/$i
	Set_Perm 0 2000 0755 /system/xbin/$i
	UI_PR "- Symlinked and set permissions for '$i'"
done
SET_PROG 0.9
UI_PR "* DONE! Busybox was installed! *"
UI_PR " "
SET_PROG 1.0
